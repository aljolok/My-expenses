<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تشخيص اتصال Firebase</title>
    <style>
        body { font-family: monospace; background-color: #111; color: #eee; padding: 20px; }
        h1 { color: #ffc107; border-bottom: 1px solid #ffc107; padding-bottom: 10px; }
        #log { list-style: none; padding: 0; }
        #log li { padding: 8px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; }
        .success::before { content: '✅'; color: #28a745; }
        .error::before { content: '❌'; color: #dc3545; }
        .info::before { content: 'ℹ️'; color: #17a2b8; }
        .pending::before { content: '⏳'; color: #ffc107; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>صفحة التشخيص الفني</h1>
    <p>هذه الصفحة تختبر الاتصال بخدمات Firebase. يرجى الانتظار 15 ثانية ثم أخذ لقطة شاشة وإرسالها.</p>
    <ul id="log"></ul>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Diagnostic Script -->
    <script>
        const logContainer = document.getElementById('log');

        function logStatus(message, status = 'info') {
            const li = document.createElement('li');
            li.className = status;
            li.textContent = message;
            logContainer.appendChild(li);
        }

        logStatus('بدء تشغيل سكربت التشخيص...', 'info');

        // 1. Check if the global firebase object is loaded
        if (typeof firebase !== 'undefined') {
            logStatus('تم تحميل مكتبة Firebase الرئيسية بنجاح.', 'success');
        } else {
            logStatus('فشل تحميل مكتبة Firebase الرئيسية. تحقق من اتصال الإنترنت أو وجود أدوات حظر.', 'error');
        }

        // 2. Try to initialize the Firebase app
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyCD6TOeIO7g6RGp89YtA1maduwMfyTE1VQ",
                authDomain: "my-expenses-81714.firebaseapp.com",
                projectId: "my-expenses-81714",
                storageBucket: "my-expenses-81714.firebasestorage.app",
                messagingSenderId: "672207051964",
                appId: "1:672207051964:web:b6e0cedc143bd06fd584b9",
                measurementId: "G-YBTY3QD4YQ"
            };
            firebase.initializeApp(firebaseConfig);
            logStatus('تم تهيئة تطبيق Firebase بنجاح (initializeApp).', 'success');
        } catch (e) {
            logStatus(`فشل تهيئة تطبيق Firebase: ${e.message}`, 'error');
        }

        // 3. Check for Auth and Firestore services
        if (firebase && typeof firebase.auth === 'function') {
            logStatus('تم العثور على خدمة المصادقة (firebase.auth).', 'success');
        } else {
            logStatus('لم يتم العثور على خدمة المصادقة. قد يكون هناك فشل في تحميل السكربت.', 'error');
        }

        if (firebase && typeof firebase.firestore === 'function') {
            logStatus('تم العثور على خدمة Firestore (firebase.firestore).', 'success');
        } else {
            logStatus('لم يتم العثور على خدمة Firestore. قد يكون هناك فشل في تحميل السكربت.', 'error');
        }

        // 4. Try to use the Auth service and set up the listener
        logStatus('محاولة إعداد مراقب حالة المصادقة (onAuthStateChanged)...', 'pending');
        let authStateChangedFired = false;
        try {
            const auth = firebase.auth();
            auth.onAuthStateChanged(user => {
                authStateChangedFired = true;
                if (user) {
                    logStatus(`تم تشغيل مراقب المصادقة. تم العثور على مستخدم (ID: ${user.uid.slice(0,10)}...).`, 'success');
                } else {
                    logStatus('تم تشغيل مراقب المصادقة. لا يوجد مستخدم مسجل حاليًا.', 'success');
                }
            });
        } catch(e) {
            logStatus(`فشل إعداد مراقب المصادقة: ${e.message}`, 'error');
        }
        
        // 5. Final check after a timeout
        setTimeout(() => {
            if (authStateChangedFired) {
                logStatus('التشخيص النهائي: مراقب المصادقة يعمل كما هو متوقع.', 'success');
            } else {
                logStatus('التشخيص النهائي: فشل تشغيل مراقب المصادقة بعد 10 ثوانٍ. هذه هي المشكلة الرئيسية.', 'error');
                logStatus('الأسباب المحتملة: مشكلة في الشبكة، جدار حماية، أو إعدادات خاطئة في Authorized Domains.', 'info');
            }
        }, 10000);

    </script>
</body>
</html>
