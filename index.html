<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المصروفات الذكية</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --c-primary: #4f46e5; --c-primary-light: #6366f1; --c-secondary: #f3f4f6; --c-text-primary: #111827; --c-text-secondary: #6b7280; --c-bg-primary: #ffffff; --c-bg-secondary: #f9fafb; --c-border: #e5e7eb; --c-success: #10b981; --c-danger: #ef4444; --c-white: #ffffff; --grad-primary: linear-gradient(135deg, var(--c-primary-light), var(--c-primary)); --grad-fab: linear-gradient(45deg, #f43f5e, #f97316); --grad-bg: linear-gradient(135deg, #f9fafb, #e5e7eb); --space-sm: 0.5rem; --space-md: 1rem; --space-lg: 1.5rem; --font-main: 'Cairo', sans-serif; --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.5rem; --fs-2xl: 2rem; --radius-md: 0.75rem; --radius-lg: 1rem; --radius-full: 9999px; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        [data-theme="dark"] { --c-primary: #6366f1; --c-primary-light: #818cf8; --c-secondary: #374151; --c-text-primary: #f9fafb; --c-text-secondary: #9ca3af; --c-bg-primary: #111827; --c-bg-secondary: #1f2937; --c-border: #374151; --grad-bg: linear-gradient(135deg, #1f2937, #111827); }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        body { font-family: var(--font-main); background: var(--grad-bg); color: var(--c-text-primary); transition: var(--transition); -webkit-font-smoothing: antialiased; }
        #app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; background-color: var(--c-bg-primary); position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-lg); transition: opacity 0.3s; position: absolute; inset: 0; }
        .hidden { display: none !important; }
        #main-app { justify-content: flex-start; padding: 0; }
        .app-header { width: 100%; padding: var(--space-md); display: flex; justify-content: space-between; align-items: center; background-color: color-mix(in srgb, var(--c-bg-primary) 80%, transparent); backdrop-filter: blur(10px); border-bottom: 1px solid var(--c-border); z-index: 10; flex-shrink: 0; }
        #main-content { flex-grow: 1; width: 100%; overflow-y: auto; padding: var(--space-md); }
        .app-nav { display: grid; grid-template-columns: repeat(5, 1fr); align-items: center; width: 100%; background-color: var(--c-bg-primary); border-top: 1px solid var(--c-border); z-index: 10; box-shadow: 0 -5px 15px -3px rgba(0,0,0,0.05); flex-shrink: 0; }
        .btn, .btn-icon, .nav-btn { border: none; cursor: pointer; font-family: inherit; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); transition: var(--transition); border-radius: var(--radius-md); }
        .btn { padding: var(--space-sm) var(--space-md); }
        .btn-primary { background: var(--grad-primary); color: var(--c-white); box-shadow: var(--shadow-md); }
        .btn-secondary { background-color: var(--c-secondary); color: var(--c-text-primary); }
        .btn-icon { background: transparent; padding: var(--space-sm); border-radius: var(--radius-full); }
        .nav-btn { flex-direction: column; gap: 0.25rem; font-size: var(--fs-sm); color: var(--c-text-secondary); background: transparent; padding: var(--space-sm) 0; position: relative; height: 100%; }
        .nav-btn.active { color: var(--c-primary); }
        .nav-fab { width: 60px; height: 60px; border-radius: var(--radius-full); background: var(--grad-fab); color: var(--c-white); box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center; border: 4px solid var(--c-bg-primary); cursor: pointer; transform: translateY(-20px); transition: var(--transition); z-index: 1; }
        .auth-card { text-align: center; padding: calc(var(--space-lg) * 2); animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .logo { width: 60px; height: 60px; background: var(--grad-primary); color: var(--c-white); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-md); }
        .auth-buttons { display: flex; flex-direction: column; gap: var(--space-md); margin-top: var(--space-lg); }
        .user-profile { display: flex; align-items: center; gap: var(--space-md); }
        #user-avatar { width: 40px; height: 40px; border-radius: var(--radius-full); object-fit: cover; background-color: var(--c-secondary); border: 2px solid var(--c-primary); }
        .page { display: flex; flex-direction: column; gap: var(--space-md); animation: fadeIn 0.5s; width: 100%; }
        .card { background-color: var(--c-bg-primary); padding: var(--space-md); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--c-border); }
        .card h3 { font-size: var(--fs-lg); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm); }
        .card .amount { font-size: var(--fs-2xl); font-weight: 700; color: var(--c-primary); }
        .item-list { display: flex; flex-direction: column; gap: var(--space-sm); }
        .expense-item, .category-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: var(--space-md); padding: var(--space-md); background-color: var(--c-bg-primary); border-radius: var(--radius-md); border-left: 4px solid transparent; transition: var(--transition); }
        .item-icon { width: 40px; height: 40px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: var(--c-white); flex-shrink: 0; }
        .item-details { flex-grow: 1; } .item-name { font-weight: 600; } .item-category { font-size: var(--fs-sm); color: var(--c-text-secondary); } .item-amount { font-weight: 700; }
        .item-actions { display: flex; } .item-actions .btn-icon { color: var(--c-text-secondary); }
        .category-item { grid-template-columns: auto 1fr auto; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); transition: opacity 0.3s; opacity: 0; }
        .modal-backdrop.active { display: flex; opacity: 1; }
        .modal { background-color: var(--c-bg-primary); padding: var(--space-lg); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; transition: var(--transition); transform: scale(0.95); opacity: 0; }
        .modal-backdrop.active .modal { transform: scale(1); opacity: 1; }
        .modal-actions { display: flex; justify-content: flex-end; gap: var(--space-md); margin-top: var(--space-md); }
        .form-group { display: flex; flex-direction: column; gap: var(--space-sm); margin-bottom: var(--space-md); }
        input, select { width: 100%; padding: var(--space-sm) var(--space-md); border: 1px solid var(--c-border); border-radius: var(--radius-md); background-color: var(--c-bg-secondary); font-family: inherit; font-size: var(--fs-base); color: var(--c-text-primary); }
        input[type="color"] { padding: 0; height: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--c-secondary); border-top-color: var(--c-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; color: var(--c-text-secondary); padding: calc(var(--space-lg) * 2) 0; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- App content will be rendered here by JavaScript -->
    </div>
    <div id="modal-container">
        <!-- Modals will be rendered here -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CORE APP LOGIC ---

            const DOMElements = {
                appContainer: document.getElementById('app-container'),
                modalContainer: document.getElementById('modal-container'),
            };

            let app, auth, db; // Will be initialized after firebase loads

            const state = {
                user: null, expenses: [], categories: [], currentPage: 'daily', isEditing: null,
                listeners: [],
                addChangeListener(listener) { this.listeners.push(listener); },
                notify() { this.listeners.forEach(listener => listener(this)); },
                setState(newState) { Object.assign(this, newState); this.notify(); },
            };

            const ui = {
                render() {
                    if (!state.user) {
                        DOMElements.appContainer.innerHTML = this.createAuthScreen();
                    } else {
                        DOMElements.appContainer.innerHTML = this.createMainAppShell(state);
                        this.renderPageContent(state);
                    }
                    lucide.createIcons();
                },
                createAuthScreen() {
                    return `<div class="screen active" id="auth-screen">
                                <div class="auth-card">
                                    <div class="logo"><i data-lucide="wallet"></i></div>
                                    <h1>المصروفات الذكية</h1>
                                    <p>تتبع نفقاتك بسهولة وأناقة.</p>
                                    <div class="auth-buttons">
                                        <button id="google-signin-btn" class="btn btn-primary"><i data-lucide="log-in"></i><span>تسجيل الدخول بـ Google</span></button>
                                        <button id="anon-signin-btn" class="btn btn-secondary"><i data-lucide="user-x"></i><span>التصفح كمجهول</span></button>
                                    </div>
                                </div>
                            </div>`;
                },
                createMainAppShell({ user, currentPage }) {
                    const defaultAvatar = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xOCAyMHYtMWMwLTIuMi0xLjgtNC00LTRoLTRjLTIuMiAwLTQgMS44LTQgNHYxIi8+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+PC9zdmc+";
                    return `<div class="screen active" id="main-app">
                                <header class="app-header">
                                    <div class="user-profile">
                                        <img id="user-avatar" src="${user.photoURL || defaultAvatar}">
                                        <div id="user-info"><h2>${user.isAnonymous ? 'مستخدم مجهول' : (user.displayName || 'مستخدم جديد')}</h2></div>
                                    </div>
                                    <div class="header-actions"><button id="theme-toggle-btn" class="btn-icon"><i data-lucide="${localStorage.getItem('theme') === 'dark' ? 'sun' : 'moon'}"></i></button></div>
                                </header>
                                <main id="main-content"></main>
                                <nav class="app-nav">
                                    <button class="nav-btn ${currentPage === 'daily' ? 'active' : ''}" data-page="daily"><i data-lucide="calendar-day"></i><span>يومي</span></button>
                                    <button class="nav-btn ${currentPage === 'monthly' ? 'active' : ''}" data-page="monthly"><i data-lucide="bar-chart-3"></i><span>شهري</span></button>
                                    <button id="fab-add-expense" class="nav-fab"><i data-lucide="plus"></i></button>
                                    <button class="nav-btn ${currentPage === 'categories' ? 'active' : ''}" data-page="categories"><i data-lucide="tags"></i><span>فئات</span></button>
                                    <button id="logout-btn" class="nav-btn"><i data-lucide="log-out"></i><span>خروج</span></button>
                                </nav>
                            </div>`;
                },
                renderPageContent(appState) {
                    const mainContent = document.getElementById('main-content');
                    if (!mainContent) return;
                    mainContent.innerHTML = '';
                    let pageContent;
                    switch (appState.currentPage) {
                        case 'daily': pageContent = this.createDailyPage(appState); break;
                        case 'monthly': pageContent = this.createMonthlyPage(appState); break;
                        case 'categories': pageContent = this.createCategoriesPage(appState); break;
                        default: pageContent = document.createElement('div');
                    }
                    mainContent.appendChild(pageContent);
                    lucide.createIcons();
                },
                createDailyPage({ expenses, categories }) {
                    const page = document.createElement('div'); page.className = 'page';
                    const today = new Date().toISOString().slice(0, 10);
                    const dailyExpenses = expenses.filter(e => e.date === today);
                    const total = dailyExpenses.reduce((sum, e) => sum + e.amount, 0);
                    page.innerHTML = `<div class="card"><h3><i data-lucide="sun"></i>مصروفات اليوم</h3><p class="amount">${utils.formatCurrency(total)}</p></div><div class="item-list"></div>`;
                    const list = page.querySelector('.item-list');
                    if (dailyExpenses.length > 0) { dailyExpenses.forEach(exp => list.insertAdjacentHTML('beforeend', this.getExpenseItemHTML(exp, categories))); } 
                    else { list.innerHTML = `<p class="empty-state">لا توجد مصروفات مسجلة اليوم.</p>`; }
                    return page;
                },
                createMonthlyPage({ expenses, categories }) {
                    const page = document.createElement('div'); page.className = 'page';
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthlyExpenses = expenses.filter(e => new Date(e.date) >= startOfMonth);
                    const total = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
                    const categoryTotals = {};
                    monthlyExpenses.forEach(exp => { categoryTotals[exp.categoryId] = (categoryTotals[exp.categoryId] || 0) + exp.amount; });
                    const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);

                    page.innerHTML = `<div class="card"><h3><i data-lucide="calendar-month"></i>ملخص الشهر</h3><p class="amount">${utils.formatCurrency(total)}</p></div><div class="card"><h3><i data-lucide="pie-chart"></i>الأعلى إنفاقًا</h3><div class="item-list"></div></div>`;
                    const catList = page.querySelector('.item-list');
                    if (sortedCategories.length > 0) {
                        sortedCategories.forEach(([catId, catTotal]) => {
                            const category = categories.find(c => c.id === catId);
                            if (!category) return;
                            const percentage = total > 0 ? (catTotal / total) * 100 : 0;
                            catList.insertAdjacentHTML('beforeend', `<div class="category-summary-item" style="display:flex; align-items:center; gap: var(--space-md);"><span style="width: 80px; text-align: right;">${category.name}</span><div class="progress-bar" style="flex-grow:1; height:8px; background-color:var(--c-secondary); border-radius:99px;"><div class="progress-fill" style="width:${percentage}%; background-color:${category.color}; height:100%; border-radius:99px;"></div></div><span>${utils.formatCurrency(catTotal)}</span></div>`);
                        });
                    } else { catList.innerHTML = `<p class="empty-state">لا توجد بيانات لهذا الشهر.</p>`; }
                    return page;
                },
                createCategoriesPage({ categories }) {
                    const page = document.createElement('div'); page.className = 'page';
                    page.innerHTML = `<div class="card"><h3><i data-lucide="tags"></i>إدارة الفئات</h3><div class="form-group"><label>اسم الفئة</label><input type="text" id="new-category-name" placeholder="مثال: تعليم"></div><div class="form-group"><label>اللون</label><input type="color" id="new-category-color" value="#8b5cf6"></div><button id="add-category-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">إضافة فئة</button></div><div class="item-list"></div>`;
                    const list = page.querySelector('.item-list');
                    if (categories.length > 0) { categories.forEach(cat => list.insertAdjacentHTML('beforeend', this.getCategoryItemHTML(cat))); }
                    else { list.innerHTML = `<p class="empty-state">لا توجد فئات مخصصة.</p>`; }
                    return page;
                },
                getExpenseItemHTML(expense, categories) {
                    const category = categories.find(c => c.id === expense.categoryId) || { name: 'غير محدد', color: '#9ca3af', icon: 'help-circle' };
                    return `<div class="expense-item" data-id="${expense.id}"><div class="item-icon" style="background-color: ${category.color};"><i data-lucide="${category.icon || 'tag'}"></i></div><div class="item-details"><p class="item-name">${utils.escapeHTML(expense.name)}</p><p class="item-category">${utils.escapeHTML(category.name)}</p></div><p class="item-amount">${utils.formatCurrency(expense.amount)}</p><div class="item-actions"><button class="btn-icon delete-expense"><i data-lucide="trash-2"></i></button></div></div>`;
                },
                getCategoryItemHTML(category) {
                    return `<div class="category-item" data-id="${category.id}"><div class="item-icon" style="background-color: ${category.color};"><i data-lucide="${category.icon || 'tag'}"></i></div><div class="item-details"><p class="item-name">${utils.escapeHTML(category.name)}</p></div><div class="item-actions"><button class="btn-icon delete-category"><i data-lucide="trash-2"></i></button></div></div>`;
                },
                toggleModal(show, content) {
                    const modalContainer = DOMElements.modalContainer;
                    if (show) {
                        modalContainer.innerHTML = `<div class="modal-backdrop active"><div class="modal">${content}</div></div>`;
                        lucide.createIcons();
                    } else {
                        modalContainer.innerHTML = '';
                    }
                },
                showExpenseModal(expense, categories) {
                    const categoryOptions = categories.map(c => `<option value="${c.id}" ${expense && expense.categoryId === c.id ? 'selected' : ''}>${utils.escapeHTML(c.name)}</option>`).join('');
                    const content = `<h3>${expense ? 'تعديل المصروف' : 'إضافة مصروف'}</h3><div class="form-group"><label>اسم المصروف</label><input type="text" id="expense-name" value="${expense ? utils.escapeHTML(expense.name) : ''}"></div><div class="form-group"><label>المبلغ</label><input type="number" id="expense-amount" value="${expense ? expense.amount : ''}"></div><div class="form-group"><label>الفئة</label><select id="expense-category">${categoryOptions}</select></div><div class="modal-actions"><button id="save-expense-btn" class="btn btn-primary">حفظ</button><button class="btn btn-secondary modal-cancel">إلغاء</button></div>`;
                    state.isEditing = expense ? { id: expense.id } : null;
                    this.toggleModal(true, content);
                },
                showConfirmation(title, message, onConfirm) {
                    const content = `<h3>${title}</h3><p>${message}</p><div class="modal-actions"><button id="confirm-yes-btn" class="btn btn-danger">نعم</button><button class="btn btn-secondary modal-cancel">لا</button></div>`;
                    this.toggleModal(true, content);
                    document.getElementById('confirm-yes-btn').addEventListener('click', () => { onConfirm(); this.toggleModal(false); });
                },
                showToast(message, type = 'success') { /* ... unchanged ... */},
                handleTheme(isDark) { document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); const themeBtn = document.getElementById('theme-toggle-btn'); if (themeBtn) { themeBtn.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>`; lucide.createIcons(); } }
            };

            const api = {
                expensesCol: (uid) => db.collection('users').doc(uid).collection('expenses'),
                categoriesCol: (uid) => db.collection('users').doc(uid).collection('categories'),
                addExpense: (uid, data) => api.expensesCol(uid).add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp(), date: new Date().toISOString().slice(0, 10) }),
                updateExpense: (uid, id, data) => api.expensesCol(uid).doc(id).update(data),
                deleteExpense: (uid, id) => api.expensesCol(uid).doc(id).delete(),
                addCategory: (uid, data) => api.categoriesCol(uid).add(data),
                deleteCategory: (uid, id) => api.categoriesCol(uid).doc(id).delete(),
                ensureDefaultCategories: async (uid, cats) => { if (cats.length > 0) return; for (const cat of [{ name: 'طعام', color: '#ef4444', icon: 'utensils' }, { name: 'مواصلات', color: '#3b82f6', icon: 'car' }, { name: 'فواتير', color: '#f97316', icon: 'receipt' }, { name: 'تسوق', color: '#10b981', icon: 'shopping-bag' }]) { await api.addCategory(uid, cat); } }
            };

            const logic = {
                init() {
                    const loadingScreen = document.createElement('div');
                    loadingScreen.className = 'screen active';
                    loadingScreen.innerHTML = `<div class="spinner"></div><p>جاري التحقق...</p>`;
                    DOMElements.appContainer.appendChild(loadingScreen);

                    const timeout = setTimeout(() => { loadingScreen.innerHTML = `<p>فشل الاتصال. الرجاء تحديث الصفحة.</p>`; }, 10000);

                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        auth = firebase.auth();
                        db = firebase.firestore();

                        auth.onAuthStateChanged(user => {
                            clearTimeout(timeout);
                            state.cleanupListeners();
                            if (user) {
                                state.user = user;
                                const unsubExpenses = api.expensesCol(user.uid).orderBy('createdAt', 'desc').onSnapshot(snap => state.setState({ expenses: snap.docs.map(doc => ({ id: doc.id, ...doc.data() })) }));
                                const unsubCategories = api.categoriesCol(user.uid).onSnapshot(snap => { const cats = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); api.ensureDefaultCategories(user.uid, cats); state.setState({ categories: cats }); });
                                state.unsubscribe.push(unsubExpenses, unsubCategories);
                            } else {
                                state.setState({ user: null, expenses: [], categories: [] });
                            }
                        });
                        
                        state.addChangeListener(ui.render.bind(ui));
                        this.setupGlobalEventListeners();

                    } catch (e) { clearTimeout(timeout); loadingScreen.innerHTML = `<p>حدث خطأ فادح أثناء التشغيل.</p>`; console.error(e); }
                },
                setupGlobalEventListeners() {
                    DOMElements.appContainer.addEventListener('click', e => {
                        const target = e.target.closest('button');
                        if (!target) return;

                        const id = target.parentElement.parentElement.dataset.id;
                        
                        if (target.id === 'google-signin-btn') auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                        else if (target.id === 'anon-signin-btn') auth.signInAnonymously();
                        else if (target.id === 'logout-btn') auth.signOut();
                        else if (target.dataset.page) state.setState({ currentPage: target.dataset.page });
                        else if (target.id === 'fab-add-expense') ui.showExpenseModal(null, state.categories);
                        else if (target.classList.contains('delete-expense')) ui.showConfirmation('حذف المصروف', 'هل أنت متأكد؟', () => api.deleteExpense(state.user.uid, id));
                        else if (target.id === 'add-category-btn') this.handleAddCategory();
                        else if (target.classList.contains('delete-category')) ui.showConfirmation('حذف الفئة', 'هل أنت متأكد؟', () => api.deleteCategory(state.user.uid, id));
                        else if (target.id === 'theme-toggle-btn') { const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; localStorage.setItem('theme', !isDark ? 'dark' : 'light'); ui.handleTheme(!isDark); }
                    });
                    DOMElements.modalContainer.addEventListener('click', e => {
                        if (e.target.closest('.modal-cancel')) ui.toggleModal(false);
                        else if (e.target.id === 'save-expense-btn') this.handleSaveExpense();
                    });
                },
                handleSaveExpense: async () => {
                    const modal = document.getElementById('expense-modal');
                    const name = modal.querySelector('#expense-name').value.trim();
                    const amount = parseFloat(modal.querySelector('#expense-amount').value);
                    const categoryId = modal.querySelector('#expense-category').value;
                    if (!name || isNaN(amount) || !categoryId) return alert("يرجى ملء جميع الحقول");
                    const data = { name, amount, categoryId };
                    const action = state.isEditing ? api.updateExpense(state.user.uid, state.isEditing.id, data) : api.addExpense(state.user.uid, data);
                    try { await action; ui.toggleModal(false); } catch (e) { alert("حدث خطأ"); }
                },
                handleAddCategory: async () => {
                    const nameInput = document.getElementById('new-category-name');
                    const colorInput = document.getElementById('new-category-color');
                    const name = nameInput.value.trim();
                    if (!name) return alert('اسم الفئة مطلوب');
                    await api.addCategory(state.user.uid, { name, color: colorInput.value, icon: 'tag' });
                    nameInput.value = '';
                },
            };
            
            const utils = { formatCurrency: (amount) => new Intl.NumberFormat('ar-AE', { style: 'currency', currency: 'AED' }).format(amount || 0), escapeHTML: (str) => str.replace(/[&<>'"]/g, tag => ({'&':'&','<':'<','>':'>',"'":''','"':'"'}[tag]||tag)) };

            logic.init();
        });
    </script>
</body>
</html>
