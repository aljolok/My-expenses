<!DOCTYPE html>
<html lang="ar" dir="rtl"> <!-- Added dir="rtl" for right-to-left -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المصروفات</title>
    <link rel="manifest" href="./manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #loading-screen, #login-screen, #main-app {
            transition: opacity 0.3s ease-in-out;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            color: #6b7280; /* Gray-500 */
            font-size: 0.75rem; /* text-xs */
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.2s, color 0.2s;
            position: relative; /* For the active indicator */
        }
        .bottom-nav-item.active {
            color: #4f46e5; /* Indigo-600 */
        }
        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -4px; /* Position above the icon */
            right: 50%; /* Changed to right for RTL */
            transform: translateX(50%); /* Changed to translateX(50%) for RTL */
            width: 30px;
            height: 4px;
            background-color: #4f46e5; /* Indigo-600 */
            border-radius: 2px;
        }
        .bottom-nav-item:hover {
            background-color: #f3f4f6;
        }
        .fab {
            position: fixed;
            bottom: 70px; /* Adjust based on bottom nav height */
            left: 50%;
            transform: translateX(-50%);
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1001;
            transition: background-color 0.2s;
        }
        .fab:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .expense-item, .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .delete-btn {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px; /* Changed to margin-right for RTL */
            border: 1px solid #ccc; /* Add a slight border for visibility */
        }

        /* Custom scrollbar for better mobile UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive adjustments for main content padding */
        #main-app-content {
            padding-bottom: 90px; /* Space for the bottom nav */
            padding-top: 60px; /* Space for the header */
            flex-grow: 1; /* Allow content to grow */
            overflow-y: auto; /* Enable scrolling for content */
        }

        /* Responsive adjustments for login screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }

        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 300px;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .google-auth-btn {
            background-color: white;
            color: #3b82f6; /* Blue-500 */
            border: 1px solid #d1d5db; /* Gray-300 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .google-auth-btn:hover {
            background-color: #f9fafb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .google-auth-btn i {
            margin-left: 10px; /* Changed to margin-left for RTL */
        }
        .anonymous-auth-btn {
            background-color: #6b7280; /* Gray-500 */
            color: white;
        }
        .anonymous-auth-btn:hover {
            background-color: #4b5563; /* Gray-700 */
        }

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center flex-col z-[3000]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        <p class="mt-4 text-gray-700 text-lg">جاري التحميل...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-lg">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">مرحباً بك!</h1>
            <p class="text-gray-600 mb-8">يرجى تسجيل الدخول للمتابعة.</p>

            <button id="google-signin-btn" class="auth-button google-auth-btn">
                <span>تسجيل الدخول باستخدام جوجل</span>
                <i class="fab fa-google text-blue-500"></i>
            </button>
            <button id="anonymous-signin-btn" class="auth-button anonymous-auth-btn">
                <span>التصفح كمجهول</span>
                <i class="fas fa-user-secret"></i>
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden flex-1 flex flex-col relative">
        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 bg-indigo-600 text-white p-4 shadow-md z-10">
            <div class="flex justify-between items-center max-w-lg mx-auto">
                <h1 id="header-title" class="text-xl font-semibold">المصروفات اليومية</h1>
                <span id="user-id-display" class="text-xs text-indigo-200"></span>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-app-content" class="flex-1 p-4 overflow-y-auto mt-16 mb-20 max-w-lg mx-auto w-full">
            <!-- Daily View -->
            <div id="daily-view" class="active-page">
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center justify-between">
                    <p class="text-lg font-medium text-gray-700">إجمالي مصروفات اليوم:</p>
                    <span id="daily-total" class="text-2xl font-bold text-indigo-600">0.00 ر.س</span>
                </div>
                <div id="daily-expenses-list" class="space-y-2">
                    <!-- Daily expenses will be rendered here -->
                </div>
                <p id="no-daily-expenses" class="text-center text-gray-500 mt-8 hidden">لا توجد مصروفات لهذا اليوم.</p>
            </div>

            <!-- Monthly View -->
            <div id="monthly-view" class="hidden">
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center justify-between">
                    <p class="text-lg font-medium text-gray-700">إجمالي مصروفات الشهر:</p>
                    <span id="monthly-total" class="text-2xl font-bold text-indigo-600">0.00 ر.س</span>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">المصروفات حسب الفئة (هذا الشهر):</h3>
                    <div id="monthly-category-summary" class="space-y-2">
                        <!-- Monthly category summary will be rendered here -->
                    </div>
                    <p id="no-monthly-expenses" class="text-center text-gray-500 mt-8 hidden">لا توجد مصروفات لهذا الشهر.</p>
                </div>
            </div>

            <!-- Categories View -->
            <div id="categories-view" class="hidden">
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">إضافة فئة جديدة:</h3>
                    <input type="text" id="new-category-name" placeholder="اسم الفئة" class="w-full p-3 border border-gray-300 rounded-md mb-3 focus:ring-2 focus:ring-indigo-400 focus:border-transparent" />
                    <div class="flex items-center mb-4">
                        <label for="new-category-color" class="ml-3 text-gray-700">لون الفئة:</label> <!-- Changed margin for RTL -->
                        <input type="color" id="new-category-color" value="#4f46e5" class="w-10 h-10 p-1 border border-gray-300 rounded-full cursor-pointer" />
                    </div>
                    <button id="add-category-btn" class="w-full bg-indigo-500 text-white p-3 rounded-md font-semibold hover:bg-indigo-600 transition duration-200">
                        إضافة فئة<i class="fas fa-plus mr-2"></i> <!-- Moved icon for RTL -->
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">الفئات الموجودة:</h3>
                    <div id="categories-list" class="space-y-2">
                        <!-- Categories will be rendered here -->
                    </div>
                    <p id="no-categories" class="text-center text-gray-500 mt-8 hidden">لا توجد فئات بعد.</p>
                </div>
            </div>
        </main>

        <!-- Floating Action Button (FAB) -->
        <button id="add-expense-fab" class="fab">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <div class="bottom-nav-item active" data-page="daily-view">
                <i class="fas fa-calendar-day text-xl"></i>
                <span class="mt-1">يومي</span>
            </div>
            <div class="bottom-nav-item" data-page="monthly-view">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="mt-1">شهري</span>
            </div>
            <div class="bottom-nav-item" data-page="categories-view">
                <i class="fas fa-tags text-xl"></i>
                <span class="mt-1">فئات</span>
            </div>
            <div class="bottom-nav-item" id="logout-btn">
                <i class="fas fa-sign-out-alt text-xl"></i>
                <span class="mt-1">خروج</span>
            </div>
        </nav>

        <!-- Expense Modal -->
        <div id="expense-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 class="text-xl font-bold text-gray-800 mb-4">إضافة مصروف جديد</h2>
                <input type="text" id="expense-name" placeholder="اسم المصروف" class="w-full p-3 border border-gray-300 rounded-md mb-3 focus:ring-2 focus:ring-indigo-400 focus:border-transparent" />
                <input type="number" id="expense-amount" placeholder="المبلغ" class="w-full p-3 border border-gray-300 rounded-md mb-3 focus:ring-2 focus:ring-indigo-400 focus:border-transparent" />
                <select id="expense-category" class="w-full p-3 border border-gray-300 rounded-md mb-3 focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                    <option value="" disabled selected>اختر فئة</option>
                    <!-- Categories will be dynamically loaded here -->
                </select>
                <button id="save-expense-btn" class="w-full bg-indigo-500 text-white p-3 rounded-md font-semibold hover:bg-indigo-600 transition duration-200">
                    حفظ المصروف<i class="fas fa-check mr-2"></i> <!-- Moved icon for RTL -->
                </button>
                <button id="cancel-expense-btn" class="w-full bg-gray-300 text-gray-800 p-3 rounded-md font-semibold mt-2 hover:bg-gray-400 transition duration-200">
                    إلغاء<i class="fas fa-times mr-2"></i> <!-- Moved icon for RTL -->
                </button>
            </div>
        </div>

        <!-- Custom Alert Modal -->
        <div id="custom-alert-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content text-center">
                <h3 id="alert-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                <p id="alert-message" class="text-gray-700 mb-6"></p>
                <button id="alert-ok-btn" class="w-full bg-indigo-500 text-white p-3 rounded-md font-semibold hover:bg-indigo-600 transition duration-200">موافق</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs (v11.9.1) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        // If you plan to use Analytics, uncomment the line below and ensure there's no typo
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

        // --- Firebase Global Variables (MUST BE USED) ---
        // These variables are provided by the Canvas environment.
        // We ensure they are defined, though the environment typically guarantees it.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            // Attempt to parse the __firebase_config string provided by the environment
            if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config !== '') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                console.warn("Environment variable __firebase_config is undefined, null, or empty. Using fallback config.");
                // Fallback to the user's provided config for debugging if environment variable is missing
                // In a real Canvas environment, __firebase_config should always be provided.
                firebaseConfig = {
                    apiKey: "AIzaSyCD6TOeIO7g6RGp89YtA1maduwMfyTE1VQ",
                    authDomain: "my-expenses-81714.firebaseapp.com",
                    projectId: "my-expenses-81714",
                    storageBucket: "my-expenses-81714.firebasestorage.app",
                    messagingSenderId: "672207051964",
                    appId: "1:672207051964:web:b6e0cedc143bd06fd584b9",
                    measurementId: "G-YBTY3QD4YQ"
                };
            }
        } catch (e) {
            console.error("Error parsing __firebase_config from environment. Using fallback config:", e);
            // Fallback to the user's provided config if parsing fails
            firebaseConfig = {
                apiKey: "AIzaSyCD6TOeIO7g6RGp89YtA1maduwMfyTE1VQ",
                authDomain: "my-expenses-81714.firebaseapp.com",
                projectId: "my-expenses-81714",
                storageBucket: "my-expenses-81714.firebasestorage.app",
                messagingSenderId: "672207051964",
                appId: "1:672207051964:web:b6e0cedc143bd06fd584b9",
                measurementId: "G-YBTY3QD4YQ"
            };
            showCustomAlert("خطأ في التهيئة", "فشل تحميل إعدادات Firebase. يرجى تحديث الصفحة.");
        }

        // Initialize Firebase App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Initialize Firestore
        const auth = getAuth(app);   // Initialize Auth
        // const analytics = getAnalytics(app); // Uncomment and use if you need Analytics

        let userId = null;
        let authStateChecked = false; // Flag to ensure auth state is processed once initially

        // --- UI Element References ---
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const anonymousSignInBtn = document.getElementById('anonymous-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        const headerTitle = document.getElementById('header-title');
        const dailyView = document.getElementById('daily-view');
        const monthlyView = document.getElementById('monthly-view');
        const categoriesView = document.getElementById('categories-view');
        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        const addExpenseFab = document.getElementById('add-expense-fab');

        const expenseModalOverlay = document.getElementById('expense-modal-overlay');
        const expenseNameInput = document.getElementById('expense-name');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseCategorySelect = document.getElementById('expense-category');
        const saveExpenseBtn = document.getElementById('save-expense-btn');
        const cancelExpenseBtn = document.getElementById('cancel-expense-btn');

        const dailyTotalSpan = document.getElementById('daily-total');
        const dailyExpensesList = document.getElementById('daily-expenses-list');
        const noDailyExpensesText = document.getElementById('no-daily-expenses');

        const monthlyTotalSpan = document.getElementById('monthly-total');
        const monthlyCategorySummary = document.getElementById('monthly-category-summary');
        const noMonthlyExpensesText = document.getElementById('no-monthly-expenses');

        const newCategoryNameInput = document.getElementById('new-category-name');
        const newCategoryColorInput = document.getElementById('new-category-color');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoriesListDiv = document.getElementById('categories-list');
        const noCategoriesText = document.getElementById('no-categories');

        const customAlertModalOverlay = document.getElementById('custom-alert-modal-overlay');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');

        let allCategories = []; // To store categories for dropdowns and display

        // --- Custom Alert Function (replaces alert() and confirm()) ---
        function showCustomAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            customAlertModalOverlay.classList.remove('hidden');
        }

        alertOkBtn.addEventListener('click', () => {
            customAlertModalOverlay.classList.add('hidden');
        });

        // --- Utility Functions ---
        function getTodayDateString() {
            const now = new Date();
            return now.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        }

        function getMonthYearString(date = new Date()) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`; // Format: YYYY-MM
        }

        function formatCurrency(amount) {
            // Using Intl.NumberFormat for better currency formatting
            return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR' }).format(amount);
        }

        function formatTimestamp(timestamp) {
            const date = timestamp.toDate(); // Convert Firebase Timestamp to Date object
            return date.toLocaleString('ar-SA', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // --- UI Screen Management ---
        function showScreen(screenId) {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            mainApp.classList.add('hidden');

            if (screenId === 'loading') {
                loadingScreen.classList.remove('hidden');
            } else if (screenId === 'login') {
                loginScreen.classList.remove('hidden');
            } else if (screenId === 'main') {
                mainApp.classList.remove('hidden');
            }
            console.log(`Switched to screen: ${screenId}`);
        }

        function showPage(pageId) {
            // Hide all pages
            dailyView.classList.add('hidden');
            monthlyView.classList.add('hidden');
            categoriesView.classList.add('hidden');

            // Show the selected page
            document.getElementById(pageId).classList.remove('hidden');

            // Update header title
            switch (pageId) {
                case 'daily-view':
                    headerTitle.textContent = 'المصروفات اليومية';
                    break;
                case 'monthly-view':
                    headerTitle.textContent = 'المصروفات الشهرية';
                    break;
                case 'categories-view':
                    headerTitle.textContent = 'إدارة الفئات';
                    break;
            }

            // Update active state in bottom nav
            bottomNavItems.forEach(item => {
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Reload data for the active page if authenticated
            if (userId && authStateChecked) {
                switch (pageId) {
                    case 'daily-view':
                        loadDailyExpenses();
                        break;
                    case 'monthly-view':
                        loadMonthlySummary();
                        break;
                    case 'categories-view':
                        loadCategories();
                        break;
                }
            }
            console.log(`Switched to page: ${pageId}`);
        }

        function showExpenseModal() {
            expenseModalOverlay.classList.remove('hidden');
            // Populate category dropdown
            expenseCategorySelect.innerHTML = '<option value="" disabled selected>اختر فئة</option>';
            if (allCategories.length > 0) {
                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    expenseCategorySelect.appendChild(option);
                });
            } else {
                 const option = document.createElement('option');
                 option.value = "";
                 option.textContent = "لا توجد فئات متاحة";
                 option.disabled = true;
                 expenseCategorySelect.appendChild(option);
            }
            expenseNameInput.value = '';
            expenseAmountInput.value = '';
        }

        function hideExpenseModal() {
            expenseModalOverlay.classList.add('hidden');
        }

        // --- Authentication Logic ---

        // This listener is the central point for managing UI based on auth state.
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged fired. User:", user ? user.uid : "null");
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `معرف المستخدم: ${userId.substring(0, 8)}...`; // Display partial ID
                showScreen('main');
                if (!authStateChecked) { // Only load data and set default page once after initial auth
                    showPage('daily-view'); // Default view
                    // Load all necessary data streams immediately after a successful initial login/auth check
                    loadCategories();
                    loadDailyExpenses();
                    loadMonthlySummary();
                    authStateChecked = true;
                }
            } else {
                userId = null;
                userIdDisplay.textContent = '';
                showScreen('login');
                authStateChecked = true; // Mark as checked even if no user, to avoid infinite loading
            }
            // Always hide loading screen once auth state is determined
            loadingScreen.classList.add('hidden');
        });

        // Event listener for DOMContentLoaded to initiate Firebase auth check early
        document.addEventListener('DOMContentLoaded', async () => {
            showScreen('loading');
            console.log("DOMContentLoaded: Initiating Firebase auth check.");
            try {
                // Check if __initial_auth_token is provided by the Canvas environment
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Custom token not provided. Attempting anonymous sign-in...");
                    await signInAnonymously(auth);
                }
                // onAuthStateChanged will handle the screen transition after sign-in attempt resolves
            } catch (error) {
                console.error("Initial Firebase sign-in failed:", error);
                showCustomAlert("خطأ في المصادقة", "فشل تسجيل الدخول الأولي. يرجى المحاولة مرة أخرى.");
                showScreen('login'); // Show login screen if initial sign-in fails
            }
        });


        googleSignInBtn.addEventListener('click', async () => {
            showScreen('loading');
            console.log("Google sign-in button clicked.");
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log("Google Sign-in successful.");
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Google Sign-in error:", error);
                let errorMessage = "حدث خطأ أثناء تسجيل الدخول باستخدام جوجل.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "تم إغلاق نافذة تسجيل الدخول.";
                } else if (error.message) {
                    errorMessage += ` التفاصيل: ${error.message}`;
                }
                showCustomAlert("خطأ في تسجيل الدخول", errorMessage);
                showScreen('login');
            }
        });

        anonymousSignInBtn.addEventListener('click', async () => {
            showScreen('loading');
            console.log("Anonymous sign-in button clicked.");
            try {
                await signInAnonymously(auth);
                console.log("Anonymous Sign-in successful.");
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Anonymous Sign-in error:", error);
                showCustomAlert("خطأ في تسجيل الدخول", `فشل تسجيل الدخول كمجهول: ${error.message}`);
                showScreen('login');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            showScreen('loading');
            console.log("Logout button clicked.");
            try {
                await signOut(auth);
                console.log("Signed out successfully.");
                // onAuthStateChanged will handle the UI update to login screen
            } catch (error) {
                console.error("Logout error:", error);
                showCustomAlert("خطأ في تسجيل الخروج", `فشل تسجيل الخروج: ${error.message}`);
                showScreen('main'); // Stay on main if logout fails
            }
        });

        // --- Firestore Operations (Data Handling) ---

        // Listener for Categories (used across app for dropdowns and categories page)
        // This function sets up a real-time listener.
        function loadCategories() {
            if (!userId) {
                console.warn("loadCategories called without userId. Skipping.");
                return;
            }
            const categoriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/categories`);
            onSnapshot(categoriesCollectionRef, (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories(allCategories);
                console.log("Categories updated from Firestore:", allCategories);
            }, (error) => {
                console.error("Error loading categories from Firestore:", error);
                showCustomAlert("خطأ", "فشل تحميل الفئات. يرجى التحقق من اتصالك بالإنترنت وقواعد Firebase.");
            });
        }

        // Listener for Daily Expenses
        function loadDailyExpenses() {
            if (!userId) {
                console.warn("loadDailyExpenses called without userId. Skipping.");
                return;
            }
            const today = getTodayDateString();
            const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            const q = query(expensesCollectionRef, where('date', '==', today));
            onSnapshot(q, (snapshot) => {
                const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpenses(expenses);
                updateDailyTotal(expenses);
                console.log("Daily expenses updated from Firestore:", expenses);
            }, (error) => {
                console.error("Error loading daily expenses from Firestore:", error);
                showCustomAlert("خطأ", "فشل تحميل المصروفات اليومية. يرجى التحقق من اتصالك بالإنترنت وقواعد Firebase.");
            });
        }

        // Listener for Monthly Summary
        function loadMonthlySummary() {
            if (!userId) {
                console.warn("loadMonthlySummary called without userId. Skipping.");
                return;
            }
            const currentMonthYear = getMonthYearString();
            const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            const q = query(expensesCollectionRef, where('monthYear', '==', currentMonthYear));
            onSnapshot(q, (snapshot) => {
                const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateMonthlyTotal(expenses);
                renderMonthlyCategorySummary(expenses);
                console.log("Monthly expenses updated from Firestore:", expenses);
            }, (error) => {
                console.error("Error loading monthly summary from Firestore:", error);
                showCustomAlert("خطأ", "فشل تحميل ملخص المصروفات الشهرية. يرجى التحقق من اتصالك بالإنترنت وقواعد Firebase.");
            });
        }


        // --- Render Functions ---
        function renderExpenses(expenses) {
            dailyExpensesList.innerHTML = '';
            if (expenses.length === 0) {
                noDailyExpensesText.classList.remove('hidden');
            } else {
                noDailyExpensesText.classList.add('hidden');
                expenses.forEach(expense => {
                    const category = allCategories.find(cat => cat.id === expense.categoryId);
                    const categoryName = category ? category.name : 'غير مصنف';
                    const categoryColor = category ? category.color : '#cccccc'; // Default gray for unknown

                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'expense-item flex items-center justify-between bg-white p-3 rounded-lg shadow-sm';
                    expenseItem.innerHTML = `
                        <div class="flex flex-col flex-grow text-right"> <!-- Added text-right for RTL -->
                            <span class="font-medium text-gray-800">${expense.name}</span>
                            <span class="text-sm text-gray-600 flex items-center justify-end"> <!-- Added justify-end for RTL -->
                                <span class="color-dot ml-2" style="background-color: ${categoryColor};"></span> <!-- Changed margin for RTL -->
                                ${categoryName}
                            </span>
                            <span class="text-xs text-gray-500">${formatTimestamp(expense.timestamp)}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-indigo-600 mr-4">${formatCurrency(expense.amount)}</span> <!-- Changed margin for RTL -->
                            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md mr-2" data-id="${expense.id}"> <!-- Changed margin for RTL -->
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    dailyExpensesList.appendChild(expenseItem);
                });

                // Add event listeners for delete buttons
                dailyExpensesList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const expenseId = e.currentTarget.dataset.id;
                        deleteExpense(expenseId);
                    });
                });
            }
        }

        function updateDailyTotal(expenses) {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            dailyTotalSpan.textContent = formatCurrency(total);
        }

        function updateMonthlyTotal(expenses) {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            monthlyTotalSpan.textContent = formatCurrency(total);
        }

        function renderMonthlyCategorySummary(expenses) {
            monthlyCategorySummary.innerHTML = '';
            if (expenses.length === 0) {
                noMonthlyExpensesText.classList.remove('hidden');
                return;
            } else {
                noMonthlyExpensesText.classList.add('hidden');
            }

            const categoryTotals = {};
            expenses.forEach(expense => {
                const category = allCategories.find(cat => cat.id === expense.categoryId);
                const categoryName = category ? category.name : 'غير مصنف';
                const categoryColor = category ? category.color : '#cccccc';

                if (!categoryTotals[categoryName]) {
                    categoryTotals[categoryName] = { total: 0, color: categoryColor };
                }
                categoryTotals[categoryName].total += expense.amount;
            });

            // Sort by total amount (descending)
            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b.total - a.total);

            sortedCategories.forEach(([name, data]) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                item.innerHTML = `
                    <div class="flex items-center">
                        ${name}
                        <span class="color-dot ml-2" style="background-color: ${data.color};"></span> <!-- Changed margin for RTL -->
                    </div>
                    <span class="font-medium text-gray-800">${formatCurrency(data.total)}</span>
                `;
                monthlyCategorySummary.appendChild(item);
            });
        }

        function renderCategories(categories) {
            categoriesListDiv.innerHTML = '';
            if (categories.length === 0) {
                noCategoriesText.classList.remove('hidden');
            } else {
                noCategoriesText.classList.add('hidden');
                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item flex items-center justify-between bg-white p-3 rounded-lg shadow-sm';
                    categoryItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="color-dot ml-2" style="background-color: ${category.color};"></span> <!-- Changed margin for RTL -->
                            <span class="font-medium text-gray-800">${category.name}</span>
                        </div>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md" data-id="${category.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    categoriesListDiv.appendChild(categoryItem);
                });

                // Add event listeners for delete buttons
                categoriesListDiv.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const categoryId = e.currentTarget.dataset.id;
                        deleteCategory(categoryId);
                    });
                });
            }
        }


        // --- CRUD Operations ---

        async function addExpense() {
            const name = expenseNameInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const categoryId = expenseCategorySelect.value;

            if (!name || isNaN(amount) || amount <= 0 || !categoryId) {
                showCustomAlert("خطأ", "الرجاء إدخال اسم ومبلغ صحيح وتحديد فئة للمصروف.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), {
                    name,
                    amount,
                    categoryId,
                    date: getTodayDateString(),
                    monthYear: getMonthYearString(),
                    timestamp: new Date() // Firebase Timestamp
                });
                hideExpenseModal();
                showCustomAlert("نجاح", "تم إضافة المصروف بنجاح!");
                expenseNameInput.value = '';
                expenseAmountInput.value = '';
                expenseCategorySelect.value = '';
            } catch (e) {
                console.error("Error adding expense document: ", e);
                showCustomAlert("خطأ", `فشل إضافة المصروف: ${e.message}`);
            }
        }

        async function deleteExpense(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses`, id));
                showCustomAlert("نجاح", "تم حذف المصروف بنجاح!");
            } catch (e) {
                console.error("Error deleting expense document: ", e);
                showCustomAlert("خطأ", `فشل حذف المصروف: ${e.message}`);
            }
        }

        async function addCategory() {
            const name = newCategoryNameInput.value.trim();
            const color = newCategoryColorInput.value;

            if (!name) {
                showCustomAlert("خطأ", "الرجاء إدخال اسم الفئة.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/categories`), {
                    name,
                    color
                });
                showCustomAlert("نجاح", "تم إضافة الفئة بنجاح!");
                newCategoryNameInput.value = '';
                newCategoryColorInput.value = '#4f46e5'; // Reset to default indigo
            } catch (e) {
                console.error("Error adding category: ", e);
                showCustomAlert("خطأ", `فشل إضافة الفئة: ${e.message}`);
            }
        }

        async function deleteCategory(id) {
            try {
                // Before deleting category, check if any expenses use it
                const expensesQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/expenses`),
                    where('categoryId', '==', id)
                );
                const expenseSnapshot = await getDocs(expensesQuery);

                if (!expenseSnapshot.empty) {
                    showCustomAlert("تحذير", "لا يمكن حذف هذه الفئة لأنها مرتبطة بمصروفات حالية. الرجاء حذف المصروفات أولاً أو تغيير فئاتها.");
                    return;
                }

                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/categories`, id));
                showCustomAlert("نجاح", "تم حذف الفئة بنجاح!");
            } catch (e) {
                console.error("Error deleting category: ", e);
                showCustomAlert("خطأ", `فشل حذف الفئة: ${e.message}`);
            }
        }

        // --- Event Listeners ---
        bottomNavItems.forEach(item => {
            item.addEventListener('click', () => {
                if (item.id === 'logout-btn') {
                    // Logout handled by its specific listener
                    return;
                }
                const pageId = item.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });

        addExpenseFab.addEventListener('click', showExpenseModal);
        cancelExpenseBtn.addEventListener('click', hideExpenseModal);
        saveExpenseBtn.addEventListener('click', addExpense);
        addCategoryBtn.addEventListener('click', addCategory);

        // Close modal on outside click
        expenseModalOverlay.addEventListener('click', (e) => {
            if (e.target === expenseModalOverlay) {
                hideExpenseModal();
            }
        });
    </script>
</body>
</html>

