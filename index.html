<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Expenses - Tracking Daily Expenses</title>
    <!-- Link to the Web App Manifest for PWA functionality -->
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS CDN for minimalist, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom CSS for overall theme and mobile optimization */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            color: #333;
            direction: rtl; /* Ensure RTL direction for the whole body */
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 100vh; /* Ensure it takes full height on small screens */
            display: flex;
            flex-direction: column;
        }
        /* Custom styles for tabs */
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #e0e7ff; /* Light blue */
            color: #4f46e5; /* Darker blue */
            text-align: center;
        }
        .tab-button.active {
            background-color: #4f46e5; /* Primary blue */
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Tab Content Transition */
        .tab-content {
            display: none;
            padding-top: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        /* Input field styling */
        input[type="text"], input[type="number"], input[type="date"] {
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1; /* Light gray border */
            border-radius: 0.75rem;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s;
            text-align: right; /* Align text right for RTL */
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #6366f1; /* Focus blue */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        /* Button styling */
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: #4f46e5; /* Primary blue */
            color: #fff;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        button:hover {
            background-color: #4338ca; /* Darker blue on hover */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .secondary-button {
            background-color: #6b7280; /* Gray */
        }
        .secondary-button:hover {
            background-color: #4b5563; /* Darker gray */
        }
        .delete-button {
            background-color: #ef4444; /* Red */
        }
        .delete-button:hover {
            background-color: #dc2626; /* Darker red */
        }
        /* Suggestion buttons */
        .suggestion-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #e0e7ff;
            color: #4f46e5;
            border: 1px solid #a5b4fc;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center;
        }
        .suggestion-button:hover {
            background-color: #c7d2fe;
        }
        /* Expense item styling */
        .expense-item {
            background-color: #f8fafc; /* Lighter white */
            border: 1px solid #e2e8f0; /* Light gray */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: pointer; /* Indicate clickable for editing */
            transition: background-color 0.2s;
        }
        .expense-item:hover {
            background-color: #eef2f6; /* Slight hover effect */
        }
        .expense-item .name {
            font-weight: 500;
            color: #333;
        }
        .expense-item .details {
            font-size: 0.875rem;
            color: #666;
            text-align: left; /* Align category and price left for RTL */
        }
        /* Adjust for icon placement in RTL */
        .expense-item .details .price {
            margin-right: 0.5rem; /* Space between category and price */
            font-weight: 600;
            color: #4f46e5;
        }
        .expense-item .details .category {
             font-size: 0.75rem;
             background-color: #bfdbfe; /* Lighter blue for category */
             color: #1e3a8a; /* Darker blue for category text */
             padding: 0.2rem 0.5rem;
             border-radius: 0.5rem;
             margin-left: 0.5rem; /* Space after category */
        }
        /* Monthly summary cards */
        .summary-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .summary-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.75rem;
            text-align: right;
        }
        .summary-card p {
            font-size: 1.125rem;
            color: #333;
            margin-bottom: 0.5rem;
            text-align: right;
        }
        .summary-card span {
            font-weight: 700;
            color: #1e3a8a;
        }
        .category-list li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
        }
        .category-list li:last-child {
            border-bottom: none;
        }
        .history-item {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
        }
        .history-item .date {
            font-weight: 600;
            color: #4f46e5;
        }
        .history-item .count {
            font-size: 0.875rem;
            color: #666;
        }
        /* Autocomplete suggestions dropdown */
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            z-index: 100;
            background-color: #fff;
            width: calc(100% - 2rem); /* Match input width, accounting for padding */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 0.5rem;
        }
        .autocomplete-suggestions div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            text-align: right; /* Align text right for RTL */
            border-bottom: 1px solid #eee;
        }
        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }
        .autocomplete-suggestions div:hover {
            background-color: #f0f2f5;
        }
         /* User ID display - Hidden as Firebase is removed */
        #userIdDisplay {
            display: none; 
        }

        /* Daily Summary Card styling */
        .daily-summary-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            text-align: right;
            cursor: pointer; /* Make it clickable */
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
        }
        .daily-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }
        .daily-summary-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.5rem;
        }
        .daily-summary-card .details {
            font-size: 0.9rem;
            color: #333;
        }
        .daily-summary-card .total {
            font-weight: 700;
            color: #1e3a8a;
            margin-right: 0.5rem;
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 350px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            flex: 1;
            padding: 0.75rem;
            font-weight: 700;
        }

        /* Toast Message */
        .toast-message {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1001;
            white-space: nowrap;
        }
        .toast-message.active {
            opacity: 1;
            visibility: visible;
        }

        /* Fade-out animation for deleted items */
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            transform: translateX(-100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-700">ØªØ·Ø¨ÙŠÙ‚ Ù…ØµØ§Ø±ÙŠÙÙŠ ğŸ’°</h1>
        <div id="userIdDisplay" class="text-sm text-gray-500 mb-4">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="currentUserId"></span></div>

        <!-- Tab Navigation -->
        <div class="flex justify-around bg-blue-100 p-2 rounded-xl mb-6 shadow-sm">
            <button id="dailyTabBtn" class="tab-button active flex-1 mx-1">
                <i class="fas fa-calendar-day ml-2"></i> Ø§Ù„ÙŠÙˆÙ…
            </button>
            <button id="monthlyTabBtn" class="tab-button flex-1 mx-1">
                <i class="fas fa-chart-bar ml-2"></i> Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ
            </button>
        </div>

        <!-- Daily Input Page -->
        <div id="dailyPage" class="tab-content active flex-grow">
            <!-- Date selection for current entry -->
            <div class="mb-4">
                <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="expenseDate" class="focus:border-blue-500">
            </div>

            <!-- Product Entry for selected date -->
            <div class="p-4 bg-blue-50 rounded-xl shadow-md mb-6">
                <h3 class="text-lg font-semibold text-blue-700 mb-4 text-right">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ù„Ù€ <span id="selectedDateDisplay" class="text-blue-900"></span>:</h3>
                <div class="mb-4 relative">
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-2 text-right">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                    <input type="text" id="productName" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¬Ø§ÙŠØ±ØŒ Ø®Ø¶Ø±ÙˆØ§Øª Ø·Ø§Ø²Ø¬Ø©" class="focus:border-blue-500">
                    <div id="autocompleteSuggestions" class="autocomplete-suggestions hidden"></div>
                </div>

                <div class="mb-4">
                    <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-2 text-right">Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ):</label>
                    <input type="number" id="productPrice" placeholder="Ù…Ø«Ø§Ù„: 20.00" step="0.01" class="focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label for="categoryDisplay" class="block text-sm font-medium text-gray-700 mb-2 text-right">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</label>
                    <div id="categoryDisplay" class="bg-blue-100 text-blue-800 text-sm font-semibold py-2 px-4 rounded-lg text-right">
                        (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
                    </div>
                </div>

                <div class="mb-4 flex justify-center flex-wrap gap-2">
                    <button id="addExpense" class="flex-1 py-3 text-lg min-w-[150px]">
                        <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
                    </button>
                    <button id="cancelEditBtn" class="secondary-button flex-1 py-3 text-lg hidden min-w-[150px]">
                        <i class="fas fa-times ml-2"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
                
                <!-- Quick Suggestion Buttons -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold text-gray-700 mb-3 text-right">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©:</h3>
                    <div id="quickSuggestions" class="flex flex-wrap gap-2 justify-end">
                        <!-- Suggestions will be dynamically loaded here -->
                    </div>
                </div>

                <!-- List of expenses for the CURRENTLY SELECTED DATE -->
                <h4 class="text-md font-semibold text-gray-800 mb-3 text-right">Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®:</h4>
                <div id="currentDateExpenseList" class="mb-4">
                    <!-- Specific expenses for the selected date will be listed here -->
                </div>
                <div class="mt-2 p-3 bg-blue-100 text-blue-900 font-bold text-lg rounded-lg text-center shadow-sm">
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="currentDateTotal">0.00 Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ</span>
                </div>
            </div>

            <!-- Daily Summary Cards for ALL recorded days -->
            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-right">Ù…Ù„Ø®Øµ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£ÙŠØ§Ù…:</h3>
            <div id="dailySummaryCards" class="flex-grow overflow-y-auto">
                <!-- Daily summary cards will be displayed here -->
            </div>
        </div>

        <!-- Monthly Summary Page -->
        <div id="monthlyPage" class="tab-content flex-grow">
            <div class="summary-card">
                <h3><i class="fas fa-chart-pie ml-2"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±: <span id="monthlyTotal">0.00 Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ</span></p>
                <p>Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ: <span id="dailyAverage">0.00 Ø¯Ø±Ù‡Ù… Ø¥Ù…Ø§Ø±Ø§ØªÙŠ</span></p>
                <p>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: <span id="daysRecorded">0</span></p>
            </div>

            <div class="summary-card">
                <h3><i class="fas fa-list-ol ml-2"></i> Ø£Ø¹Ù„Ù‰ ÙØ¦Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚</h3>
                <ul id="topCategoriesList" class="category-list">
                    <!-- Top categories will be displayed here -->
                </ul>
            </div>

            <div class="summary-card">
                <h3><i class="fas fa-history ml-2"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¢Ø®Ø± 10 Ø£ÙŠØ§Ù…)</h3>
                <div id="expenseHistoryList">
                    <!-- Expense history will be displayed here -->
                </div>
            </div>

            <!-- Export/Import Data Buttons -->
            <div class="summary-card">
                <h3><i class="fas fa-database ml-2"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <div class="flex flex-col gap-3">
                    <button id="exportDataBtn" class="py-2 secondary-button w-full">
                        <i class="fas fa-download ml-2"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <input type="file" id="importFileInput" accept=".json" class="hidden" />
                    <button id="importDataBtn" class="py-2 secondary-button w-full">
                        <i class="fas fa-upload ml-2"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button id="clearAllDataBtn" class="py-2 delete-button w-full">
                        <i class="fas fa-trash-alt ml-2"></i> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <p id="confirmModalText" class="mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <div class="modal-buttons">
                <button id="confirmActionBtn" class="delete-button">ØªØ£ÙƒÙŠØ¯</button>
                <button id="cancelActionBtn" class="secondary-button">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Toast Message -->
    <div id="toastMessage" class="toast-message"></div>

    <script>
        // --- Global Variables and Constants ---
        const EXPENSES_STORAGE_KEY = 'myExpenses_expenses';
        const MAX_HISTORY_DAYS = 10;

        const DEFAULT_CATEGORIES = [
            { name: 'Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ù„Ø¨Ø§Ù†', keywords: ['Ø­Ù„ÙŠØ¨', 'Ù„Ø¨Ù†', 'Ø¬Ø¨Ù†Ø©', 'Ø²Ø¨Ø§Ø¯ÙŠ', 'Ù‚Ø´Ø·Ø©', 'Ø²Ø¨Ø¯Ø©', 'Ø²Ø¨Ø¯Ù‡'] },
            { name: 'Ø§Ù„Ù„Ø­ÙˆÙ…', keywords: ['Ù„Ø­Ù…', 'Ø¯Ø¬Ø§Ø¬', 'Ø³Ù…Ùƒ', 'Ø¨Ø±Ø¬Ø±', 'Ù†Ù‚Ø§Ù†Ù‚', 'ÙƒØ¨Ø§Ø¨', 'Ø¯Ø¬Ø§Ø¬Ø©'] },
            { name: 'Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª', keywords: ['Ø®Ø¶Ø§Ø±', 'ÙØ§ÙƒÙ‡Ø©', 'Ø·Ø§Ø²Ø¬Ø©', 'Ø¨Ù†Ø¯ÙˆØ±Ø©', 'Ø®ÙŠØ§Ø±', 'ØªÙØ§Ø­', 'Ø¨Ø±ØªÙ‚Ø§Ù„', 'Ù…ÙˆØ²', 'Ø¨Ø·Ø§Ø·Ø§', 'Ø¬Ø²Ø±'] },
            { name: 'Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©', keywords: ['ÙˆØ¬Ø¨Ø©', 'Ù…Ø·Ø¹Ù…', 'Ø³Ø±ÙŠØ¹', 'Ø¨ÙŠØªØ²Ø§', 'Ø´Ø§ÙˆØ±Ù…Ø§', 'Ø¨Ø±Ø¬Ø±', 'Ø³Ø§Ù†Ø¯ÙˆÙŠØªØ´', 'Ø¨Ø§Ø³ØªØ§', 'Ø¬Ø§Ù‡Ø²Ø©'] },
            { name: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª', keywords: ['Ø¹ØµÙŠØ±', 'Ù…Ø§Ø¡', 'ØµÙˆØ¯Ø§', 'Ù‚Ù‡ÙˆØ©', 'Ø´Ø§ÙŠ', 'Ù…Ø´Ø±ÙˆØ¨', 'ÙƒÙˆÙ„Ø§', 'Ø¨ÙŠØ¨Ø³ÙŠ', 'Ù…ÙŠØ§Ù‡'] },
            { name: 'Ø§Ù„ØªØ¯Ø®ÙŠÙ†', keywords: ['Ø³Ø¬Ø§ÙŠØ±', 'Ø¯Ø®Ø§Ù†', 'Ø´ÙŠØ´Ø©', 'Ù…Ø¹Ø³Ù„'] },
            { name: 'Ø§Ù„Ù…Ø¹Ù„Ø¨Ø§Øª', keywords: ['Ù…Ø¹Ù„Ø¨Ø§Øª', 'ØªÙˆÙ†Ø§', 'ÙÙˆÙ„', 'Ø­Ù…Øµ', 'Ù…Ø±Ø¨Ù‰', 'Ø¹Ø¯Ø³ Ù…Ø¹Ù„Ø¨'] },
            { name: 'Ø§Ù„ØªÙˆØ§Ø¨Ù„', keywords: ['Ø¨Ù‡Ø§Ø±Ø§Øª', 'ÙÙ„ÙÙ„', 'ÙƒÙ…ÙˆÙ†', 'Ù…Ù„Ø­', 'ÙƒØ±ÙƒÙ…', 'Ø¨Ø§Ø¨Ø±ÙŠÙƒØ§'] },
            { name: 'Ø£Ø®Ø±Ù‰', keywords: [] } // Default fallback category
        ];

        let expenses = []; // Array to store all expense objects
        let productMemory = {}; // Local cache for autocomplete and quick suggestions
        let isEditing = false; // Flag to indicate if an item is being edited
        let editingExpenseId = null; // Stores the ID of the expense being edited

        // --- DOM Elements ---
        const dailyTabBtn = document.getElementById('dailyTabBtn');
        const monthlyTabBtn = document.getElementById('monthlyTabBtn');
        const dailyPage = document.getElementById('dailyPage');
        const monthlyPage = document.getElementById('monthlyPage');

        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const expenseDateInput = document.getElementById('expenseDate'); // Date input
        const selectedDateDisplay = document.getElementById('selectedDateDisplay'); // To show selected date in input card
        const categoryDisplay = document.getElementById('categoryDisplay');
        const addExpenseBtn = document.getElementById('addExpense');
        const cancelEditBtn = document.getElementById('cancelEditBtn'); // New Cancel Edit button
        const currentDateExpenseList = document.getElementById('currentDateExpenseList'); // Specific items for selected date
        const currentDateTotalDisplay = document.getElementById('currentDateTotal'); // Total for selected date
        const dailySummaryCardsContainer = document.getElementById('dailySummaryCards'); // All daily summaries
        const quickSuggestionsContainer = document.getElementById('quickSuggestions');
        const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');

        const monthlyTotalDisplay = document.getElementById('monthlyTotal');
        const dailyAverageDisplay = document.getElementById('dailyAverage');
        const daysRecordedDisplay = document.getElementById('daysRecorded');
        const topCategoriesList = document.getElementById('topCategoriesList');
        const expenseHistoryList = document.getElementById('expenseHistoryList');

        // Modal Elements (unified for all confirmations)
        const confirmModalOverlay = document.getElementById('confirmModalOverlay');
        const confirmModalText = document.getElementById('confirmModalText');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelActionBtn = document.getElementById('cancelActionBtn');
        let pendingConfirmAction = null; // Stores the function to call on confirm

        // Toast Message Element
        const toastMessageElement = document.getElementById('toastMessage');

        // Export/Import/Clear All Buttons
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const importFileInput = document.getElementById('importFileInput');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');


        // --- Helper Functions ---

        /**
         * Shows a toast message.
         * @param {string} message - The message to display.
         * @param {number} duration - Duration in milliseconds (default: 3000).
         */
        function showToast(message, duration = 3000) {
            toastMessageElement.textContent = message;
            toastMessageElement.classList.add('active');
            setTimeout(() => {
                toastMessageElement.classList.remove('active');
            }, duration);
        }

        /**
         * Shows the confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} onConfirmCallback - Callback function to execute on confirmation.
         * @param {string} confirmButtonText - Optional text for the confirm button.
         */
        function showConfirmModal(message, onConfirmCallback, confirmButtonText = 'ØªØ£ÙƒÙŠØ¯') {
            confirmModalText.textContent = message;
            confirmActionBtn.textContent = confirmButtonText;
            confirmModalOverlay.classList.add('active');
            pendingConfirmAction = onConfirmCallback; // Store the callback

            // Set up event listeners for modal buttons
            confirmActionBtn.onclick = () => {
                if (pendingConfirmAction) {
                    pendingConfirmAction(true); // Pass true to confirm action
                }
                hideConfirmModal();
            };
            cancelActionBtn.onclick = () => {
                if (pendingConfirmAction) {
                    pendingConfirmAction(false); // Pass false to cancel action
                }
                hideConfirmModal();
            };
        }

        /**
         * Hides the confirmation modal.
         */
        function hideConfirmModal() {
            confirmModalOverlay.classList.remove('active');
            confirmActionBtn.onclick = null; // Remove listeners to prevent memory leaks
            cancelActionBtn.onclick = null;
            pendingConfirmAction = null;
        }

        /**
         * Generates a unique ID for an expense item.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * Gets the current date in YYYY-MM-DD format.
         * @returns {string} The formatted date string.
         */
        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Formats a number as UAE Dirham currency.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-AE', {
                style: 'currency',
                currency: 'AED',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        /**
         * Saves the expenses array to local storage.
         */
        function saveExpenses() {
            localStorage.setItem(EXPENSES_STORAGE_KEY, JSON.stringify(expenses));
            rebuildProductMemoryFromExpenses(); // Update product memory when expenses change
            updateQuickSuggestions(); // Update quick suggestions
        }

        /**
         * Loads expenses from local storage.
         */
        function loadExpenses() {
            const storedExpenses = localStorage.getItem(EXPENSES_STORAGE_KEY);
            if (storedExpenses) {
                expenses = JSON.parse(storedExpenses);
                // Ensure expenses are sorted by timestamp (if available) or date
                expenses.sort((a, b) => new Date(a.timestamp || a.date) - new Date(b.timestamp || b.date));
            } else {
                expenses = [];
            }
            rebuildProductMemoryFromExpenses(); // Build product memory on load
        }

        /**
         * Suggests a category based on the product name using keywords and product memory.
         * @param {string} productName - The name of the product.
         * @returns {string} The suggested category or 'Ø£Ø®Ø±Ù‰' (Other) if no match.
         */
        function suggestCategory(productName) {
            const lowerProductName = productName.toLowerCase();

            // First, check product memory for exact match or close match
            for (const name in productMemory) {
                if (lowerProductName.includes(name.toLowerCase()) || name.toLowerCase().includes(lowerProductName)) {
                    return productMemory[name].lastCategory;
                }
            }

            // If not found in memory, use default categories
            for (const category of DEFAULT_CATEGORIES) {
                for (const keyword of category.keywords) {
                    if (lowerProductName.includes(keyword.toLowerCase())) {
                        return category.name;
                    }
                }
            }
            return 'Ø£Ø®Ø±Ù‰'; // Default category if no match
        }

        /**
         * Renders detailed expenses for the currently selected date.
         */
        function renderCurrentDateExpenses() {
            const selectedDate = expenseDateInput.value;
            selectedDateDisplay.textContent = selectedDate; // Update display in input card
            const expensesForSelectedDate = expenses.filter(exp => exp.date === selectedDate);
            currentDateExpenseList.innerHTML = '';
            let totalForSelectedDate = 0;

            if (expensesForSelectedDate.length === 0) {
                currentDateExpenseList.innerHTML = `
                    <p class="text-center text-gray-500 py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¹Ø¯. Ø£Ø¶Ù ÙˆØ§Ø­Ø¯Ø§Ù‹!</p>
                `;
            } else {
                expensesForSelectedDate.forEach(exp => {
                    totalForSelectedDate += exp.price;
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'expense-item';
                    expenseItem.dataset.id = exp.id; // Store ID for editing
                    expenseItem.innerHTML = `
                        <div class="name text-right">${exp.name}</div>
                        <div class="details flex items-center justify-start">
                            <span class="category">${exp.category}</span>
                            <span class="price">${formatCurrency(exp.price)}</span>
                            <button class="delete-btn text-red-500 hover:text-red-700 ml-2 p-1 rounded-full" data-id="${exp.id}" aria-label="Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    currentDateExpenseList.appendChild(expenseItem);
                });
            }
            currentDateTotalDisplay.textContent = formatCurrency(totalForSelectedDate);

            // Add event listeners for delete buttons
            document.querySelectorAll('#currentDateExpenseList .delete-btn').forEach(button => {
                button.onclick = (event) => {
                    event.stopPropagation(); // Prevent expense-item click when delete button is clicked
                    const idToDelete = event.currentTarget.dataset.id;
                    showConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${expenses.find(e => e.id === idToDelete)?.name}"ØŸ`, (confirmed) => {
                        if (confirmed) {
                            deleteExpense(idToDelete);
                        }
                    }, 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù');
                };
            });

            // Add event listeners for editing expense items
            document.querySelectorAll('#currentDateExpenseList .expense-item').forEach(item => {
                item.onclick = (event) => {
                    // Only activate edit if not clicking the delete button itself
                    if (!event.target.closest('.delete-btn')) {
                        editExpense(item.dataset.id);
                    }
                };
            });
        }


        /**
         * Renders daily summary cards for all recorded days.
         */
        function renderDailySummaries() {
            dailySummaryCardsContainer.innerHTML = '';
            
            // Group expenses by date and calculate total for each day
            const dailyTotalsMap = new Map(); // Map<string (date), { total: number, count: number }>
            expenses.forEach(exp => {
                const date = exp.date;
                if (!dailyTotalsMap.has(date)) {
                    dailyTotalsMap.set(date, { total: 0, count: 0 });
                }
                const dayData = dailyTotalsMap.get(date);
                dayData.total += exp.price;
                dayData.count += 1;
            });

            // Convert map to array and sort by date descending
            const sortedDailySummaries = Array.from(dailyTotalsMap.entries())
                .map(([date, data]) => ({ date, total: data.total, count: data.count }))
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            if (sortedDailySummaries.length === 0) {
                dailySummaryCardsContainer.innerHTML = `
                    <p class="text-center text-gray-500 py-8">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯. Ø£Ø¶Ù ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù„ØªØ±Ù‰ Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ø£ÙŠØ§Ù… Ù‡Ù†Ø§!
                        <i class="fas fa-hand-pointer mr-1"></i>
                    </p>
                `;
            } else {
                sortedDailySummaries.forEach(summary => {
                    const card = document.createElement('div');
                    card.className = 'daily-summary-card';
                    card.dataset.date = summary.date; // Store date for click event
                    card.innerHTML = `
                        <h4><i class="fas fa-calendar-alt ml-2"></i> ${summary.date}</h4>
                        <div class="details">
                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="total">${formatCurrency(summary.total)}</span>
                            <span class="ml-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${summary.count}</span>
                        </div>
                    `;
                    dailySummaryCardsContainer.appendChild(card);
                });

                // Add event listeners for clickable daily summary cards
                document.querySelectorAll('.daily-summary-card').forEach(card => {
                    card.addEventListener('click', (event) => {
                        const dateToLoad = event.currentTarget.dataset.date;
                        expenseDateInput.value = dateToLoad; // Set the date input
                        renderCurrentDateExpenses(); // Refresh the expenses for that date
                        dailyTabBtn.click(); // Switch to daily tab if not already there
                    });
                });
            }
        }

        /**
         * Rebuilds productMemory from the current expenses array.
         */
        function rebuildProductMemoryFromExpenses() {
            productMemory = {}; // Clear existing memory
            expenses.forEach(exp => {
                if (productMemory[exp.name]) {
                    productMemory[exp.name].lastPrice = exp.price;
                    productMemory[exp.name].lastCategory = exp.category;
                    productMemory[exp.name].frequency = (productMemory[exp.name].frequency || 0) + 1;
                } else {
                    productMemory[exp.name] = { lastPrice: exp.price, lastCategory: exp.category, frequency: 1 };
                }
            });
        }

        /**
         * Renders quick suggestion buttons based on frequently bought items from productMemory.
         */
        function updateQuickSuggestions() {
            quickSuggestionsContainer.innerHTML = '';
            const sortedProducts = Object.entries(productMemory)
                .sort(([, a], [, b]) => b.frequency - a.frequency)
                .slice(0, 5); // Show top 5 frequent items

            if (sortedProducts.length === 0) {
                quickSuggestionsContainer.innerHTML = `
                    <p class="text-gray-500 text-sm w-full text-center">
                        Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„ØªØ±Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù‡Ù†Ø§.
                    </p>
                `;
                return;
            }

            sortedProducts.forEach(([name, data]) => {
                const button = document.createElement('button');
                button.className = 'suggestion-button';
                button.textContent = `${name} (${formatCurrency(data.lastPrice)})`;
                button.onclick = () => {
                    productNameInput.value = name;
                    productPriceInput.value = data.lastPrice;
                    categoryDisplay.textContent = data.lastCategory;
                    // expenseDateInput.value = getTodayDateString(); // Keep current selected date for quick add
                    productPriceInput.focus();
                };
                quickSuggestionsContainer.appendChild(button);
            });
        }

        /**
         * Handles the addition or update of an expense and saves it to local storage.
         */
        async function addOrUpdateExpense() {
            const productName = productNameInput.value.trim();
            const productPrice = parseFloat(productPriceInput.value);
            const expenseDate = expenseDateInput.value; // Get selected date
            const suggestedCategory = categoryDisplay.textContent.replace('(ØªÙ„Ù‚Ø§Ø¦ÙŠ)', '').trim();

            if (!productName || isNaN(productPrice) || productPrice <= 0 || !expenseDate) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.', 3000);
                return;
            }

            if (isEditing) {
                // Update existing expense
                const index = expenses.findIndex(exp => exp.id === editingExpenseId);
                if (index !== -1) {
                    expenses[index] = {
                        ...expenses[index], // Keep existing properties
                        date: expenseDate,
                        name: productName,
                        price: productPrice,
                        category: suggestedCategory,
                        timestamp: new Date().toISOString() // Update timestamp for re-sorting
                    };
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
                }
                isEditing = false;
                editingExpenseId = null;
                addExpenseBtn.innerHTML = '<i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
                cancelEditBtn.classList.add('hidden');
            } else {
                // Add new expense
                const newExpense = {
                    id: generateUniqueId(),
                    date: expenseDate,
                    name: productName,
                    price: productPrice,
                    category: suggestedCategory,
                    timestamp: new Date().toISOString()
                };
                expenses.push(newExpense);
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯!', 2000);
            }

            // Sort expenses by timestamp after add/update
            expenses.sort((a, b) => new Date(a.timestamp || a.date) - new Date(b.timestamp || b.date));
            saveExpenses(); // Save to local storage

            // Clear input fields after adding/updating
            productNameInput.value = '';
            productPriceInput.value = '';
            // expenseDateInput.value = getTodayDateString(); // DO NOT reset date here, keep selected date
            categoryDisplay.textContent = '(ØªÙ„Ù‚Ø§Ø¦ÙŠ)';
            productNameInput.focus();

            renderCurrentDateExpenses(); // Re-render items for current date
            renderDailySummaries(); // Re-render all daily summary cards
            updateMonthlySummary(); // Ensure monthly summary is updated
        }

        /**
         * Populates the input fields for editing an expense.
         * @param {string} id - The ID of the expense to edit.
         */
        function editExpense(id) {
            const expenseToEdit = expenses.find(exp => exp.id === id);
            if (expenseToEdit) {
                productNameInput.value = expenseToEdit.name;
                productPriceInput.value = expenseToEdit.price;
                expenseDateInput.value = expenseToEdit.date;
                categoryDisplay.textContent = expenseToEdit.category;
                
                isEditing = true;
                editingExpenseId = id;
                addExpenseBtn.innerHTML = '<i class="fas fa-edit ml-2"></i> ØªØ­Ø¯ÙŠØ« Ù…ØµØ±ÙˆÙ';
                cancelEditBtn.classList.remove('hidden');
                productNameInput.focus();
            }
        }

        /**
         * Cancels the current edit operation and resets the form.
         */
        function cancelEdit() {
            isEditing = false;
            editingExpenseId = null;
            productNameInput.value = '';
            productPriceInput.value = '';
            // expenseDateInput.value = getTodayDateString(); // Optionally reset date, or keep it
            categoryDisplay.textContent = '(ØªÙ„Ù‚Ø§Ø¦ÙŠ)';
            addExpenseBtn.innerHTML = '<i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
            cancelEditBtn.classList.add('hidden');
            productNameInput.focus();
        }

        /**
         * Deletes an expense from local storage.
         * @param {string} id - The ID of the expense to delete.
         */
        function deleteExpense(id) {
            const itemElement = document.querySelector(`.expense-item[data-id="${id}"]`);
            if (itemElement) {
                // Add fade-out class before removing from DOM
                itemElement.classList.add('fade-out');
                // Remove from DOM after animation
                itemElement.addEventListener('transitionend', () => {
                    expenses = expenses.filter(exp => exp.id !== id);
                    saveExpenses(); // Save updated expenses to local storage
                    renderCurrentDateExpenses(); // Re-render items for current date
                    renderDailySummaries(); // Re-render summaries
                    updateMonthlySummary(); // Update monthly summary
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
                    // If we were editing this item, cancel edit mode
                    if (editingExpenseId === id) {
                        cancelEdit();
                    }
                });
            } else {
                // Fallback if element not found (shouldn't happen often)
                expenses = expenses.filter(exp => exp.id !== id);
                saveExpenses();
                renderCurrentDateExpenses();
                renderDailySummaries();
                updateMonthlySummary();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
                if (editingExpenseId === id) {
                    cancelEdit();
                }
            }
        }

        /**
         * Exports all expense data to a JSON file.
         */
        function exportData() {
            const dataStr = JSON.stringify(expenses, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_expenses_backup_${getTodayDateString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 2000);
        }

        /**
         * Imports expense data from a JSON file.
         */
        function importData() {
            importFileInput.click(); // Trigger file input click
        }

        /**
         * Handles the selected file for import.
         * @param {Event} event - The change event from the file input.
         */
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedExpenses = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedExpenses)) {
                        showToast('ØµÙŠØºØ© Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.', 3000);
                        return;
                    }

                    showConfirmModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©.', (confirmed) => {
                        if (confirmed) {
                            let newItemsAdded = 0;
                            let duplicatesIgnored = 0;

                            importedExpenses.forEach(importedExp => {
                                // Basic validation for imported expense structure
                                if (importedExp.date && importedExp.name && typeof importedExp.price === 'number' && importedExp.category) {
                                    // Check if this imported expense already exists in our current data
                                    const isDuplicate = expenses.some(existingExp =>
                                        existingExp.date === importedExp.date &&
                                        existingExp.name === importedExp.name &&
                                        existingExp.price === importedExp.price &&
                                        existingExp.category === importedExp.category
                                    );

                                    if (!isDuplicate) {
                                        // Ensure unique ID for imported item to avoid future collisions
                                        importedExp.id = generateUniqueId();
                                        // Ensure timestamp is present for proper sorting
                                        if (!importedExp.timestamp) {
                                            importedExp.timestamp = new Date().toISOString();
                                        }
                                        expenses.push(importedExp);
                                        newItemsAdded++;
                                    } else {
                                        duplicatesIgnored++;
                                    }
                                } else {
                                    console.warn("Skipping invalid imported expense item:", importedExp);
                                }
                            });

                            if (newItemsAdded > 0 || duplicatesIgnored > 0) {
                                // Sort expenses after adding new ones
                                expenses.sort((a, b) => new Date(a.timestamp || a.date) - new Date(b.timestamp || b.date));
                                saveExpenses(); // Save updated expenses
                                renderCurrentDateExpenses();
                                renderDailySummaries();
                                updateMonthlySummary();
                                showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newItemsAdded} Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯. ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${duplicatesIgnored} Ù…ØµØ±ÙˆÙ Ù…ÙƒØ±Ø±.`, 5000);
                            } else {
                                showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØµØ§Ø±ÙŠÙ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.', 3000);
                            }
                        }
                    }, 'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªÙˆØ±Ø¯');
                } catch (error) {
                    console.error("Error parsing imported JSON:", error);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ù„Ù JSON ØµØ­ÙŠØ­.', 3000);
                }
                importFileInput.value = ''; // Clear file input
            };
            reader.readAsText(file);
        }

        /**
         * Clears all local expense data.
         */
        function clearAllData() {
            showConfirmModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem(EXPENSES_STORAGE_KEY); // Directly clear from local storage
                    expenses = []; // Reset array
                    productMemory = {}; // Reset product memory
                    renderCurrentDateExpenses(); // Re-render current date (empty)
                    renderDailySummaries(); // Re-render all summaries (empty)
                    updateQuickSuggestions(); // Clear quick suggestions
                    updateMonthlySummary(); // Reset monthly summary
                    showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 2000);
                    cancelEdit(); // Exit any edit mode
                }
            }, 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­');
        }


        /**
         * Updates and renders the monthly summary page.
         */
        function updateMonthlySummary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
            });

            let monthlyTotal = 0;
            const uniqueDays = new Set();
            const categoryTotals = {};
            const dailyItemCounts = {};

            monthlyExpenses.forEach(exp => {
                monthlyTotal += exp.price;
                uniqueDays.add(exp.date);
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.price;
                dailyItemCounts[exp.date] = (dailyItemCounts[exp.date] || 0) + 1;
            });

            const daysRecorded = uniqueDays.size;
            const dailyAverage = daysRecorded > 0 ? monthlyTotal / daysRecorded : 0;

            monthlyTotalDisplay.textContent = formatCurrency(monthlyTotal);
            dailyAverageDisplay.textContent = formatCurrency(dailyAverage);
            daysRecordedDisplay.textContent = daysRecorded;

            // Render Top Categories
            topCategoriesList.innerHTML = '';
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                 topCategoriesList.innerHTML = `
                    <p class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØ¦Ø§Øª Ø¨Ø¹Ø¯.</p>
                 `;
            } else {
                sortedCategories.forEach(([category, total]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${category}</span>
                        <span>${formatCurrency(total)}</span>
                    `;
                    topCategoriesList.appendChild(li);
                });
            }

            // Render Expense History (last 10 days)
            expenseHistoryList.innerHTML = '';
            // Get all unique dates from expenses, sort them descending, and take the last MAX_HISTORY_DAYS
            const allUniqueDates = [...new Set(expenses.map(exp => exp.date))].sort().reverse();
            const recentDates = allUniqueDates.slice(0, MAX_HISTORY_DAYS);

            if (recentDates.length === 0) {
                expenseHistoryList.innerHTML = `
                    <p class="text-center text-gray-500 py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯.</p>
                `;
            } else {
                recentDates.forEach(date => {
                    const itemsForDate = expenses.filter(exp => exp.date === date).length;
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <span class="date">${date}</span>
                        <span class="count">${itemsForDate} Ø¹Ù†Ø§ØµØ±</span>
                    `;
                    expenseHistoryList.appendChild(historyItem);
                });
            }
        }

        /**
         * Handles product name input for auto-complete and price/category recall.
         */
        function handleProductNameInput() {
            const inputVal = productNameInput.value.trim();
            autocompleteSuggestions.innerHTML = '';

            if (inputVal.length > 0) {
                const matches = Object.keys(productMemory).filter(name =>
                    name.toLowerCase().includes(inputVal.toLowerCase())
                ).slice(0, 5);

                if (matches.length > 0) {
                    autocompleteSuggestions.classList.remove('hidden');
                    matches.forEach(name => {
                        const div = document.createElement('div');
                        div.textContent = name;
                        div.onclick = () => {
                            productNameInput.value = name;
                            productPriceInput.value = productMemory[name].lastPrice;
                            categoryDisplay.textContent = productMemory[name].lastCategory;
                            autocompleteSuggestions.classList.add('hidden');
                            productPriceInput.focus();
                        };
                        autocompleteSuggestions.appendChild(div);
                    });
                } else {
                    autocompleteSuggestions.classList.add('hidden');
                }
            } else {
                autocompleteSuggestions.classList.add('hidden');
            }

            const suggestedCat = suggestCategory(inputVal);
            categoryDisplay.textContent = suggestedCat === 'Ø£Ø®Ø±Ù‰' ? '(ØªÙ„Ù‚Ø§Ø¦ÙŠ)' : suggestedCat;
        }

        // --- Event Listeners ---

        // Tab switching
        dailyTabBtn.addEventListener('click', () => {
            dailyTabBtn.classList.add('active');
            monthlyTabBtn.classList.remove('active');
            dailyPage.classList.add('active');
            monthlyPage.classList.remove('active');
            renderDailySummaries(); // Re-render all daily summary cards
            renderCurrentDateExpenses(); // Re-render expenses for the current selected date
            cancelEdit(); // Reset edit mode when switching tabs
        });

        monthlyTabBtn.addEventListener('click', () => {
            monthlyTabBtn.classList.add('active');
            dailyTabBtn.classList.remove('active');
            monthlyPage.classList.add('active');
            dailyPage.classList.remove('active');
            updateMonthlySummary(); // Explicitly update when switching to ensure it's fresh
            cancelEdit(); // Reset edit mode when switching tabs
        });

        // Add/Update expense button click
        addExpenseBtn.addEventListener('click', addOrUpdateExpense);

        // Cancel Edit button click
        cancelEditBtn.addEventListener('click', cancelEdit);

        // Keyboard support (Enter key)
        productNameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (!autocompleteSuggestions.classList.contains('hidden') && autocompleteSuggestions.children.length > 0) {
                    autocompleteSuggestions.children[0].click();
                } else {
                    productPriceInput.focus();
                }
            }
        });

        productPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                addOrUpdateExpense();
            }
        });

        // Product name input for suggestions and category auto-detection
        productNameInput.addEventListener('input', handleProductNameInput);

        // Hide autocomplete suggestions when clicking outside
        document.addEventListener('click', (event) => {
            if (!productNameInput.contains(event.target) && !autocompleteSuggestions.contains(event.target)) {
                autocompleteSuggestions.classList.add('hidden');
            }
        });

        // Date input change event
        expenseDateInput.addEventListener('change', () => {
            renderCurrentDateExpenses(); // Re-render expenses for the newly selected date
        });

        // Export/Import/Clear All Data Listeners
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', importData);
        importFileInput.addEventListener('change', handleImportFile);
        clearAllDataBtn.addEventListener('click', () => {
            showConfirmModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem(EXPENSES_STORAGE_KEY); // Directly clear from local storage
                    expenses = []; // Reset array
                    productMemory = {}; // Reset product memory
                    renderCurrentDateExpenses(); // Re-render current date (empty)
                    renderDailySummaries(); // Re-render all summaries (empty)
                    updateQuickSuggestions(); // Clear quick suggestions
                    updateMonthlySummary(); // Reset monthly summary
                    showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 2000);
                    cancelEdit(); // Exit any edit mode
                }
            }, 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­');
        });


        // --- PWA Service Worker Registration ---
        // This part registers the service worker for offline capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to today and display it
            const todayString = getTodayDateString();
            expenseDateInput.value = todayString;
            selectedDateDisplay.textContent = todayString; // Initialize selected date display

            loadExpenses(); // Load existing expenses from local storage
            renderDailySummaries(); // Render all daily summary cards
            renderCurrentDateExpenses(); // Render expenses for today (initial selected date)
            updateQuickSuggestions(); // Update quick suggestions on load
            updateMonthlySummary(); // Initialize monthly summary
        });
    </script>
</body>
</html>

